<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Disentangle Things</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="Disentangle Things"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2013-10-19T20:36+1100"/>
<meta name="author" content="Ivan Hanigan"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Disentangle Things</h1>


<hr/>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Introduction</a></li>
<li><a href="#sec-2">2 Test Data</a>
<ul>
<li><a href="#sec-2-1">2.1 Test Data for Classification Trees</a></li>
</ul>
</li>
<li><a href="#sec-3">3 Data Input - Remote</a>
<ul>
<li><a href="#sec-3-1">3.1 Database Connection</a>
<ul>
<li><a href="#sec-3-1-1">3.1.1 connect2postgres</a></li>
<li><a href="#sec-3-1-2">3.1.2 connect2oracle</a></li>
</ul>
</li>
<li><a href="#sec-3-2">3.2 Database Input</a>
<ul>
<li><a href="#sec-3-2-1">3.2.1 readOGR2</a></li>
<li><a href="#sec-3-2-2">3.2.2 PSQL dump and restore</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-4">4 Data Input - Local</a>
<ul>
<li><a href="#sec-4-1">4.1 Download File from HTTPS</a>
<ul>
<li><a href="#sec-4-1-1">4.1.1 download-file-https-code</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-5">5 Data Operation</a>
<ul>
<li><a href="#sec-5-1">5.1 R-subset</a></li>
<li><a href="#sec-5-2">5.2 R-transform</a></li>
<li><a href="#sec-5-3">5.3 R-mutate</a></li>
<li><a href="#sec-5-4">5.4 R-summarise</a></li>
<li><a href="#sec-5-5">5.5 R-arrange</a></li>
</ul>
</li>
<li><a href="#sec-6">6 Data Output</a></li>
<li><a href="#sec-7">7 Data Documentation</a>
<ul>
<li><a href="#sec-7-1">7.1 R-reml-and-rfigshare</a></li>
<li><a href="#sec-7-2">7.2 R-reml-and-rfigshare-part-2</a></li>
<li><a href="#sec-7-3">7.3 dc-uploader-and-ANU-DataCommons</a></li>
<li><a href="#sec-7-4">7.4 morpho-and-rfigshare</a></li>
<li><a href="#sec-7-5">7.5 R-spss-variable-labels-read</a></li>
</ul>
</li>
<li><a href="#sec-8">8 Exploratory Data Analysis</a></li>
<li><a href="#sec-9">9 General Purpose</a></li>
<li><a href="#sec-10">10 Visualisation</a></li>
<li><a href="#sec-11">11 Statistical Modelling</a>
<ul>
<li><a href="#sec-11-1">11.1 Tree-Based Methods</a></li>
<li><a href="#sec-11-2">11.2 Misclassification Error Rate for Classification Trees</a></li>
<li><a href="#sec-11-3">11.3 Deviance Based Measures of Descriptive Power for Classification Trees</a></li>
</ul>
</li>
<li><a href="#sec-12">12 Code Editors</a></li>
<li><a href="#sec-13">13 Workflow Tools</a>
<ul>
<li><a href="#sec-13-1">13.1 R-newnode</a>
<ul>
<li><a href="#sec-13-1-1">13.1.1 test-newnode</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-14">14 Graphical User Interfaces</a></li>
<li><a href="#sec-15">15 Version Control</a></li>
<li><a href="#sec-16">16 Latex/Sweave</a></li>
<li><a href="#sec-17">17 R Packages</a></li>
<li><a href="#sec-18">18 Project Management</a></li>
<li><a href="#sec-19">19 Operating Systems</a></li>
<li><a href="#sec-20">20 Big Data Tips</a></li>
<li><a href="#sec-21">21 Writing</a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">

<p>This project is my collection of notes and customised software tools for data management, manipulation and analysis.
</p>



<pre class="src src-R"><span style="color: #7f9f7f;">################################################################</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">devtools is recommended</span>
<span style="color: #bfebbf; font-weight: bold;">require</span>(devtools)
install_github(<span style="color: #cc9393;">"disentangle"</span>, <span style="color: #cc9393;">"ivanhanigan"</span>)
<span style="color: #bfebbf; font-weight: bold;">require</span>(disentangle)
</pre>

</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Test Data</h2>
<div class="outline-text-2" id="text-2">



</div>

<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Test Data for Classification Trees</h3>
<div class="outline-text-3" id="text-2-1">




<pre class="src src-R"><span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">A fictitious sample dataset</span>
For discussion, I<span style="color: #cc9393;">'ll use a fictional example dataset that I'</span>m using to work through some statistical theory related to Classification and Regression Trees (CART).
In the motivating example use case we are interested <span style="color: #f0dfaf; font-weight: bold;">in</span> predicting the civil status (married, single, divorced/widowed) of individuals from their sex (male, female) and sector of activity (primary, secondary, tertiary). The data set is composed of 273 cases.

The data (and related statistical theory) come from:

- Ritschard, G. (2006). Computing and using the deviance with classification trees. In Compstat 2006 - Proceedings <span style="color: #f0dfaf; font-weight: bold;">in</span> Computational Statistics 17th Symposium Held <span style="color: #f0dfaf; font-weight: bold;">in</span> Rome, Italy, 2006. Retrieved from [This Link](http://mephisto.unige.ch/pub/publications/gr/ritschard_compstat06.pdf)

- Ritschard, G., Pisetta, V., &amp; Zighed, D. (2008). Inducing and evaluating classification trees with statistical implicative criteria. Statistical Implicative Analysis. Studies <span style="color: #f0dfaf; font-weight: bold;">in</span> Computational Intelligence Volume 127, pp 397-419. Retrieved from [This Link](http://mephisto.unige.ch/pub/publications/gr/ritsch-pisetta-zighed_bookGras_rev.pdf)

<span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">Code:</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">copy and paste the data from the PDF (Table 1 in both papers)</span>
    civst_gend_sector  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> read.csv(textConnection(
        <span style="color: #cc9393;">"civil_status gender activity_sector number_of_cases</span>
<span style="color: #cc9393;">             married   male         primary              50</span>
<span style="color: #cc9393;">             married   male       secondary              40</span>
<span style="color: #cc9393;">             married   male        tertiary               6</span>
<span style="color: #cc9393;">             married female         primary               0</span>
<span style="color: #cc9393;">             married female       secondary              14</span>
<span style="color: #cc9393;">             married female        tertiary              10</span>
<span style="color: #cc9393;">              single   male         primary               5</span>
<span style="color: #cc9393;">              single   male       secondary               5</span>
<span style="color: #cc9393;">              single   male        tertiary              12</span>
<span style="color: #cc9393;">              single female         primary              50</span>
<span style="color: #cc9393;">              single female       secondary              30</span>
<span style="color: #cc9393;">              single female        tertiary              18</span>
<span style="color: #cc9393;">    divorced/widowed   male         primary               5</span>
<span style="color: #cc9393;">    divorced/widowed   male       secondary               8</span>
<span style="color: #cc9393;">    divorced/widowed   male        tertiary              10</span>
<span style="color: #cc9393;">    divorced/widowed female         primary               6</span>
<span style="color: #cc9393;">    divorced/widowed female       secondary               2</span>
<span style="color: #cc9393;">    divorced/widowed female        tertiary               2</span>
<span style="color: #cc9393;">    "</span>),sep = <span style="color: #cc9393;">""</span>)

    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">save this to my personal R utilities package "disentangle" </span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">for use later when I am exploring functions</span>
    dir.create(<span style="color: #cc9393;">"inst/extdata"</span>, recursive=T)
    write.csv(civst_gend_sector, <span style="color: #cc9393;">"inst/extdata/civst_gend_sector.csv"</span>, row.names = F)

<span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">Motivating reason for using these data</span>
Classification and Regression Tree models (also referred to as Decision Trees) are one of the building blocks of data mining and a great tool <span style="color: #f0dfaf; font-weight: bold;">for</span> Exploratory Data Analysis.

I<span style="color: #cc9393;">'ve mostly used Regression Trees in the past but recently got some work with social science data where Classification Trees were needed.  I wanted to assess the deviance as well as the misclassification error rate for measuring the descriptive power of the tree.  While this is a easy with Regression Trees it became obvious that it was not so easy with Classification Trees.  This is because Classification Trees are most often evaluated by means of the error rate. The problem with the error rate is that it is not that helpful for assessing the descriptive capacity of the tree.</span>

<span style="color: #cc9393;">For example if we look at the reduction in deviance between the Null model and the fitted tree we can say that the tree explains about XYZ% of the variation. We can also test if this is a statistically significant reduction based on a chi-squared test.</span>

<span style="color: #cc9393;">Consider this example from page 310 of Hastie, T., Tibshirani, R., &amp; Friedman, J. (2001). The elements of statistical learning. 2nd Edition:</span>

<span style="color: #cc9393;">- in a two-class problem with 400 observations in each class (denote this by (400, 400))</span>
<span style="color: #cc9393;">- suppose one split created nodes (300, 100) and (100, 300), </span>
<span style="color: #cc9393;">- the other created nodes (200, 400) and (200, 0). </span>
<span style="color: #cc9393;">- Both splits produce a misclassification rate of 0.25, but the second split produces a pure node and is probably preferable.</span>

<span style="color: #cc9393;">During the course of my research to try to identify the best available method to implement in my analysis I found a useful series of papers by Ritschard, with a worked example using SPSS.  I hope to translate that to R in the future, but the first thing I did was grab the example data used in several of those papers out of the PDF.  So seeing as this was a public dataset (I use a lot of restricted data) and because I want to be able to use it to demonstrate the use of any R functions I find or write... I thought would publish it properly.  </span>

<span style="color: #cc9393;">#### The Tree Model</span>
<span style="color: #cc9393;">So just before we leave Ritschard and the CART method, let'</span>s just fit the model.  Let<span style="color: #cc9393;">'s also install my R utilities package "disentangle", to test that we can access the data from it.</span>

<span style="color: #cc9393;">In this analysis the civil status is the outcome (or response or decision or dependent) variable, while sex and activity sector are the predictors (or condition or independent variables). </span>

<span style="color: #cc9393;">#### Code: </span>
<span style="color: #cc9393;">    # func</span>
<span style="color: #cc9393;">    require(rpart)</span>
<span style="color: #cc9393;">    require(partykit) </span>
<span style="color: #cc9393;">    require(devtools)</span>
<span style="color: #cc9393;">    install_github("disentangle", "ivanhanigan")</span>
<span style="color: #cc9393;">    </span>
<span style="color: #cc9393;">    # load</span>
<span style="color: #cc9393;">    fpath &lt;- system.file(file.path("extdata", "civst_gend_sector.csv"),</span>
<span style="color: #cc9393;">                         package = "disentangle"</span>
<span style="color: #cc9393;">                         )</span>
<span style="color: #cc9393;">    civst_gend_sector &lt;- read.csv(fpath)</span>

<span style="color: #cc9393;">    # clean</span>
<span style="color: #cc9393;">    str(civst_gend_sector)</span>
<span style="color: #cc9393;">    </span>
<span style="color: #cc9393;">    # do</span>
<span style="color: #cc9393;">    fit &lt;- rpart(civil_status ~ gender + activity_sector,</span>
<span style="color: #cc9393;">                 data = civst_gend_sector, weights = number_of_cases,</span>
<span style="color: #cc9393;">                 control=rpart.control(minsplit=1))</span>
<span style="color: #cc9393;">    # NB need minsplit to be adjusted for weights.</span>
<span style="color: #cc9393;">    summary(fit)</span>
<span style="color: #cc9393;">      </span>
<span style="color: #cc9393;">    # report</span>
<span style="color: #cc9393;">    dir.create("images")</span>
<span style="color: #cc9393;">    png("images/fit1.png", 1000, 480)</span>
<span style="color: #cc9393;">    plot(as.party(fit))</span>
<span style="color: #cc9393;">    dev.off()</span>

<span style="color: #cc9393;">#### The Result</span>
</pre>


</div>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Data Input - Remote</h2>
<div class="outline-text-2" id="text-3">


</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Database Connection</h3>
<div class="outline-text-3" id="text-3-1">


</div>

<div id="outline-container-3-1-1" class="outline-4">
<h4 id="sec-3-1-1"><span class="section-number-4">3.1.1</span> <span class="todo TODO">TODO</span> connect2postgres</h4>
<div class="outline-text-4" id="text-3-1-1">

</div>

</div>

<div id="outline-container-3-1-2" class="outline-4">
<h4 id="sec-3-1-2"><span class="section-number-4">3.1.2</span> <span class="todo TODO">TODO</span> connect2oracle</h4>
<div class="outline-text-4" id="text-3-1-2">

</div>
</div>

</div>

<div id="outline-container-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Database Input</h3>
<div class="outline-text-3" id="text-3-2">


</div>

<div id="outline-container-3-2-1" class="outline-4">
<h4 id="sec-3-2-1"><span class="section-number-4">3.2.1</span> <span class="todo TODO">TODO</span> readOGR2</h4>
<div class="outline-text-4" id="text-3-2-1">

</div>

</div>

<div id="outline-container-3-2-2" class="outline-4">
<h4 id="sec-3-2-2"><span class="section-number-4">3.2.2</span> PSQL dump and restore</h4>
<div class="outline-text-4" id="text-3-2-2">




<pre class="src src-sh"><span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">name:psql-dump-restore</span>
<span style="color: #cc9393;">"C:\Program Files\pgAdmin III\1.8\pg_dump.exe"</span> -h ip_address -p 5432 -U user_name -F t -v -i -f <span style="color: #cc9393;">"z:pathtobackup_file.backup"</span> -t <span style="color: #cc9393;">\"</span>public<span style="color: #cc9393;">\"</span>.<span style="color: #cc9393;">\"</span>table<span style="color: #cc9393;">\"</span> databaseName

<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">Or for an entire schema</span>

<span style="color: #cc9393;">"C:\Program Files\pgAdmin III\1.8\pg_dump.exe"</span> -h ip_address -p 5432 -U user_name -F t -v -i -f <span style="color: #cc9393;">"z:\path\to\backup_file.backup"</span> -n <span style="color: #cc9393;">\"</span>public<span style="color: #cc9393;">\"</span> databaseName

<span style="color: #7f9f7f;">#</span><span style="color: #7f9f7f;">You can dump and restore in a single line directly to your local postgres server</span>

pg_dump -h ip_address -U username -i -t schema.table weather | psql -h localhost postgis

<span style="color: #7f9f7f;">#</span><span style="color: #7f9f7f;">You can dump and restore in a single line between databases</span>

<span style="color: #cc9393;">"C:\Program Files\PostgreSQL\8.3\bin\pg_dump"</span> -h ip_address -U username -i -t schema.table database | <span style="color: #cc9393;">"C:\Program Files\PostgreSQL\8.3\bin\psql"</span> -h ipaddress -U username database

<span style="color: #7f9f7f;">#</span><span style="color: #7f9f7f;">To copy to a CSV file</span>

<span style="color: #cc9393;">"C:\Program Files\PostgreSQL\8.3\bin\psql"</span> -h ip_address -d weather -U username -c <span style="color: #cc9393;">"COPY \"schema\".\"table\" TO STDOUT WITH CSV HEADER;"</span> &gt; <span style="color: #cc9393;">"J:\workdir\filename.csv"</span>

<span style="color: #cc9393;">"C:\Program Files\PostgreSQL\8.3\bin\psql"</span> -h ip_address -d weather -U username -c <span style="color: #cc9393;">"COPY (select * from schema.table where var = X) TO STDOUT WITH CSV HEADER;"</span> &gt; <span style="color: #cc9393;">"J:\workdir\filename.csv"</span>
</pre>

</div>
</div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Data Input - Local</h2>
<div class="outline-text-2" id="text-4">


</div>

<div id="outline-container-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Download File from HTTPS</h3>
<div class="outline-text-3" id="text-4-1">


</div>

<div id="outline-container-4-1-1" class="outline-4">
<h4 id="sec-4-1-1"><span class="section-number-4">4.1.1</span> download-file-https-code</h4>
<div class="outline-text-4" id="text-4-1-1">




<pre class="src src-R"><span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">use method = curl</span>
download.file(<span style="color: #cc9393;">'https://alliance.anu.edu.au/access/content/group/4e0f55f1-b540-456a-000a-24730b59fccb/R%20Resources/Intro%20to%20R/timedata.csv'</span>,
              <span style="color: #cc9393;">'~/timedata.csv'</span>,
              method =<span style="color: #cc9393;">'curl'</span>
              )
timedata <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> read.csv(<span style="color: #cc9393;">'~/timedata.csv'</span>)
</pre>


</div>
</div>
</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Data Operation</h2>
<div class="outline-text-2" id="text-5">



</div>

<div id="outline-container-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> R-subset</h3>
<div class="outline-text-3" id="text-5-1">




<pre class="src src-R"><span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">R-subset</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">Filter rows by criteria</span>
    subset(airquality, Temp &gt; 90, select = c(Ozone, Temp))

    <span style="color: #7f9f7f;">## </span><span style="color: #7f9f7f;">NB This is a convenience function intended for use interactively.  For</span>
    <span style="color: #7f9f7f;">## </span><span style="color: #7f9f7f;">programming it is better to use the standard subsetting functions like</span>
    <span style="color: #7f9f7f;">## </span><span style="color: #7f9f7f;">&#8216;[&#8217;, and in particular the non-standard evaluation of argument</span>
    <span style="color: #7f9f7f;">## </span><span style="color: #7f9f7f;">&#8216;subset&#8217; can have unanticipated consequences.</span>

    with(airquality,
         airquality[Temp &gt; 90, c(<span style="color: #cc9393;">"Ozone"</span>, <span style="color: #cc9393;">"Temp"</span>)]
         )

    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">OR</span>

    airquality[airquality$Temp &gt; 90,  c(<span style="color: #cc9393;">"Ozone"</span>, <span style="color: #cc9393;">"Temp"</span>)]
                                                                               
</pre>

</div>

</div>

<div id="outline-container-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> R-transform</h3>
<div class="outline-text-3" id="text-5-2">




<pre class="src src-R"><span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">R-transform</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">New columns that are functions of other columns       </span>
    df <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> transform(airquality,
                    new = -Ozone,
                    Temp2 = (Temp-32)/1.8
                    )
    head(df)


</pre>

</div>

</div>

<div id="outline-container-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> R-mutate</h3>
<div class="outline-text-3" id="text-5-3">




<pre class="src src-R"><span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">R-mutate</span>
    <span style="color: #bfebbf; font-weight: bold;">require</span>(plyr)
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">same thing as transform</span>
    df <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> mutate(airquality, new = -Ozone, Temp = (Temp - 32) / 1.8)    
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">Things transform can't do</span>
    df <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> mutate(airquality, Temp = (Temp - 32) / 1.8, OzT = Ozone / Temp)
    
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">mutate is rather faster than transform</span>
    system.time(transform(baseball, avg_ab = ab / g))
    system.time(mutate(baseball, avg_ab = ab / g))

</pre>

</div>

</div>

<div id="outline-container-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> R-summarise</h3>
<div class="outline-text-3" id="text-5-4">




<pre class="src src-R"><span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">R-summarise</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">New data.frame where columns are functions of existing columns</span>
    <span style="color: #bfebbf; font-weight: bold;">require</span>(plyr)    
    df <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> ddply(.data = airquality,
                .variables = <span style="color: #cc9393;">"Month"</span>,
                .fun = summarise,
                tmax = max(Temp),
                tav = mean(Temp),
                ndays = length(unique(Day))
                )
    head(df)

<span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">Passing variables to ddply for summary</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">Notice how the name of the variable Temp doesn't need quotes?</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">this means that you need to hard code the names</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">But if you want to pass variables to this inside a function we need a</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">different approach.</span>

    <span style="color: #8cd0d3;">summarise_df</span>  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> <span style="color: #f0dfaf; font-weight: bold;">function</span>(x, by, var1, var2, var3)
      {
        data_out <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> ddply(x,
                          by,
                          <span style="color: #f0dfaf; font-weight: bold;">function</span>(df) <span style="color: #f0dfaf; font-weight: bold;">return</span>(
                            c(
                              tmax = max(df[,var1]),
                              tav = mean(df[,var2]),
                              ndays = length(unique(df[,var3]))
                              )
                            )
                          )
        <span style="color: #f0dfaf; font-weight: bold;">return</span>(data_out)
      }

    df2 <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> summarise_df(x = airquality, by = <span style="color: #cc9393;">"Month"</span>,
                       var1 = <span style="color: #cc9393;">"Temp"</span>, var2 = <span style="color: #cc9393;">"Temp"</span>, var3 = <span style="color: #cc9393;">"Day"</span>
                       )
    
    head(df2)
    all.equal(df,df2)
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">TRUE</span>

<span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">Another alternative, if we want to pass the dataset as string too</span>
    <span style="color: #8cd0d3;">summarise_df2</span>  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> <span style="color: #f0dfaf; font-weight: bold;">function</span>(x, by, var1, var2, var3)
      {
        data_out <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> eval(
          parse(
            text =
            sprintf(
              <span style="color: #cc9393;">"ddply(.data = %s,</span>
<span style="color: #cc9393;">                .variables = '%s',</span>
<span style="color: #cc9393;">                .fun = summarise,</span>
<span style="color: #cc9393;">                tmax = max(%s),</span>
<span style="color: #cc9393;">                tav = mean(%s),</span>
<span style="color: #cc9393;">                ndays = length(unique(%s))</span>
<span style="color: #cc9393;">                )"</span>, x, by, var1, var2, var3
              )
            )
          )
        <span style="color: #f0dfaf; font-weight: bold;">return</span>(data_out)
      }

    df3 <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> summarise_df2(x = <span style="color: #cc9393;">"airquality"</span>, by = <span style="color: #cc9393;">"Month"</span>,
                         var1 = <span style="color: #cc9393;">"Temp"</span>, var2 = <span style="color: #cc9393;">"Temp"</span>, var3 = <span style="color: #cc9393;">"Day"</span>
                         )
    head(df3)
    all.equal(df, df3)
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">TRUE</span>
</pre>

</div>

</div>

<div id="outline-container-5-5" class="outline-3">
<h3 id="sec-5-5"><span class="section-number-3">5.5</span> R-arrange</h3>
<div class="outline-text-3" id="text-5-5">




<pre class="src src-R"><span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">R-arrange</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">Re-order the rows of a data.frame</span>
    df <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> arrange(airquality, Temp, Ozone)
    head(df)
</pre>



</div>
</div>

</div>

<div id="outline-container-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Data Output</h2>
<div class="outline-text-2" id="text-6">

</div>

</div>

<div id="outline-container-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Data Documentation</h2>
<div class="outline-text-2" id="text-7">




</div>

<div id="outline-container-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> R-reml-and-rfigshare</h3>
<div class="outline-text-3" id="text-7-1">




<pre class="src src-R">---
name: data-documentation-case-study-reml-and-rfigshare
layout: post
title: data-documentation-case-study-reml-and-rfigshare
date: 2013-10-12
categories:
- Data Documentation
---

<span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">Case Study: reml-and-rfigshare</span>
First we will look at the work of the ROpenSci team and the reml
package.  In the vignette they show how to publish data to figshare
using rfigshare package.  [figshare](http://figshare.com/) is a site
where scientists can share datasets/figures/code. The goals are to
encourage researchers to share negative results and make reproducible
research efforts user-friendly. It also uses a tagging system <span style="color: #f0dfaf; font-weight: bold;">for</span>
scientific research discovery. They give you unlimited public space
and 1GB of private space.  

Start by getting the reml package.

<span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">Code:</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">func</span>
    <span style="color: #bfebbf; font-weight: bold;">require</span>(devtools)
    install_github(<span style="color: #cc9393;">"reml"</span>, <span style="color: #cc9393;">"ropensci"</span>)
    <span style="color: #bfebbf; font-weight: bold;">require</span>(reml)
    ?eml_write
&lt;p&gt;&lt;/p&gt;
This is the Top-level API <span style="color: #f0dfaf; font-weight: bold;">function</span> <span style="color: #f0dfaf; font-weight: bold;">for</span> writing eml.  Help page is a bit sparse.  See [This Link](https://github.com/ropensci/reml) <span style="color: #f0dfaf; font-weight: bold;">for</span> more.  For eg <span style="color: #cc9393;">"for convenience, dat could simply be a data.frame and reml will launch it's metadata wizard to assist in constructing the metadata based on the data.frame provided. While this may be helpful starting out, regular users will find it faster to define the columns and units directly in the format above."</span>


Now load up the test data <span style="color: #f0dfaf; font-weight: bold;">for</span> classification trees I described <span style="color: #f0dfaf; font-weight: bold;">in</span> [This Post](/2013/10/test-data-<span style="color: #f0dfaf; font-weight: bold;">for</span>-classification-trees/)

<span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">Code:</span>
    install_github(<span style="color: #cc9393;">"disentangle"</span>, <span style="color: #cc9393;">"ivanhanigan"</span>) <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">for the data</span>
                                                 <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">described in prev post</span>

    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">load</span>
    fpath <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> system.file(file.path(<span style="color: #cc9393;">"extdata"</span>, <span style="color: #cc9393;">"civst_gend_sector.csv"</span>),
                         package = <span style="color: #cc9393;">"disentangle"</span>
                         )
    civst_gend_sector <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> read.csv(fpath)

    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">clean</span>
    str(civst_gend_sector)

    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">do</span>
    eml_write(civst_gend_sector,
              creator = <span style="color: #cc9393;">"Ivan Hanigan <a href="mailto:ivanhanigan%40gmail.com">&lt;ivanhanigan@gmail.com&gt;</a>"</span>)


              


    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">Starts up the wizard, a section is shown below.  The wizard</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">prompts in the console and the user writes the answer.</span>

    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">Enter description for column 'civil_status':</span>
    <span style="color: #7f9f7f;">#  </span><span style="color: #7f9f7f;">marriage status</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">column civil_status appears to contain categorical data.</span>
    <span style="color: #7f9f7f;">#  </span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">Categories are divorced/widowed, married, single</span>
    <span style="color: #7f9f7f;">#  </span><span style="color: #7f9f7f;">Please define each of the categories at the prompt</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">define 'divorced/widowed':</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">was once married</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">define 'married':</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">still married</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">define 'single':</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">never married</span>

    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">TODO I don't really know what activity_sector is.  I assumed</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">school because Categories are primary, secondary, tertiary.</span>

    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">this created "metadata.xml" and "metadata.csv"</span>
    file.remove(c(<span style="color: #cc9393;">"metadata.xml"</span>,<span style="color: #cc9393;">"metadata.csv"</span>))
&lt;p&gt;&lt;/p&gt;  
This was a very minimal data documentation effort.  A bit more detail would be better.  Because I would now need to re-write all that <span style="color: #f0dfaf; font-weight: bold;">in</span> the wizard I will take the advice of the help file that <span style="color: #cc9393;">"regular users will find it faster to define the columns and units directly in the format"</span>

<span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">Code:</span>
    ds <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> data.set(civst_gend_sector,
                   col.defs = c(<span style="color: #cc9393;">"Marriage status"</span>, <span style="color: #cc9393;">"sex"</span>, <span style="color: #cc9393;">"education"</span>, <span style="color: #cc9393;">"counts"</span>),
                   unit.defs = list(c(<span style="color: #cc9393;">"was once married"</span>,<span style="color: #cc9393;">"still married"</span>,<span style="color: #cc9393;">"never married"</span>),
                       c(<span style="color: #cc9393;">"women"</span>, <span style="color: #cc9393;">"men"</span>),
                       c(<span style="color: #cc9393;">"primary school"</span>,<span style="color: #cc9393;">"secondary school"</span>,<span style="color: #cc9393;">"tertiary school"</span>),
                       c(<span style="color: #cc9393;">"persons"</span>))
                   )
    ds
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">this prints the dataset and the metadata</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">now run the EML function</span>
    eml_write(ds, 
              title = <span style="color: #cc9393;">"civst_gend_sector"</span>,  
              description = <span style="color: #cc9393;">"An example, fictional dataset for Decision Tree Models"</span>,
              creator = <span style="color: #cc9393;">"Ivan Hanigan <a href="mailto:ivanhanigan%40gmail.com">&lt;ivanhanigan@gmail.com&gt;</a>"</span>,
              file = <span style="color: #cc9393;">"inst/extdata/civst_gend_sector_eml.xml"</span>
              )
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">this created the xml and csv with out asking anything</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">but returned a</span>
    <span style="color: #7f9f7f;">## </span><span style="color: #7f9f7f;">Warning message:</span>
    <span style="color: #7f9f7f;">## </span><span style="color: #7f9f7f;">In `[&lt;-.data.frame`(`*tmp*`, , value = list(civil_status = c(2L,  :</span>
    <span style="color: #7f9f7f;">##   </span><span style="color: #7f9f7f;">Setting class(x) to NULL;   result will no longer be an S4 object</span>

    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">TODO investigate this?</span>

    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">now we can access the local EML</span>
    obj <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> eml_read(<span style="color: #cc9393;">"inst/extdata/civst_gend_sector_eml.xml"</span>)
    obj 
    str(dataTable(obj))
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">returns an error</span>
    <span style="color: #7f9f7f;">## </span><span style="color: #7f9f7f;">Error in plyr::compact(lapply(slotNames(from), function(s) if (!isEmpty(slot(from,  (from attribute.R#300) : </span>
    <span style="color: #7f9f7f;">##   </span><span style="color: #7f9f7f;">subscript out of bounds</span>
&lt;p&gt;&lt;/p&gt;

<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">Conclusions</span>
So this looks like a useful tool.  Next steps are to:

- look at sending these data to figshare
- describe a really really REALLY simple workflow (3 lines? create metadata, eml_write, push to figshare)
  
  
</pre>

</div>

</div>

<div id="outline-container-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> R-reml-and-rfigshare-part-2</h3>
<div class="outline-text-3" id="text-7-2">




<pre class="src src-R">---
name: reml-and-rfigshare-part-2
layout: post
title: reml-and-rfigshare-part-2
date: 2013-10-12
categories:
- Data Documentation
---

In the last post I explored the functionality of reml.
This time I will try to send data to figshare.

- First follow [These Instructions](https://github.com/ropensci/rfigshare) to get rfigshare set up.  In particular store your figshare credentials <span style="color: #f0dfaf; font-weight: bold;">in</span> ~/.Rprofile

<span style="color: #7f9f7f;">#### </span><span style="color: #7f9f7f;">Code:reml-and-rfigshare-part-2</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">func</span>
    <span style="color: #bfebbf; font-weight: bold;">require</span>(devtools)
    install_github(<span style="color: #cc9393;">"reml"</span>, <span style="color: #cc9393;">"ropensci"</span>)
    <span style="color: #bfebbf; font-weight: bold;">require</span>(reml)
    install_github(<span style="color: #cc9393;">"rfigshare"</span>, <span style="color: #cc9393;">"ropensci"</span>)
    <span style="color: #bfebbf; font-weight: bold;">require</span>(rfigshare)
    install_github(<span style="color: #cc9393;">"disentangle"</span>, <span style="color: #cc9393;">"ivanhanigan"</span>)
    <span style="color: #bfebbf; font-weight: bold;">require</span>(disentangle)
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">load</span>
    fpath <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> system.file(file.path(<span style="color: #cc9393;">"extdata"</span>,<span style="color: #cc9393;">"civst_gend_sector_eml.xml"</span>), package = <span style="color: #cc9393;">"disentangle"</span>)
    setwd(dirname(fpath))
    obj <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> eml_read(fpath)
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">clean</span>
    obj
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">do</span>

    <span style="color: #7f9f7f;">## </span><span style="color: #7f9f7f;">STEP 1: find one of the preset categories</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">available. We can ask the API for</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">a list of all the categories:</span>
    list <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> fs_category_list()
    list[grep(<span style="color: #cc9393;">"Survey"</span>, list)]

    <span style="color: #7f9f7f;">## </span><span style="color: #7f9f7f;">STEP 2: PUBLISH TO FIGSHARE</span>
    id <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> eml_publish(fname,
                      description=<span style="color: #cc9393;">"Example EML</span>
<span style="color: #cc9393;">                        A fictional dataset"</span>,
                      categories = <span style="color: #cc9393;">"Survey results"</span>,
                      tags = <span style="color: #cc9393;">"EML"</span>,
                      destination=<span style="color: #cc9393;">"figshare"</span>
                      )
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">there are several warnings</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">but go to figshare and it has sent the metadata and data OK</span>

    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">make public using either the figshare web interface, the</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">rfigshare package (using fs_make_public(id)) or just by adding</span>
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">the argument visibility = TRUE to the above eml_publish</span>
    fs_make_public(id)

    
&lt;p&gt;&lt;/p&gt;
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">Now these data are on figshare</span>

Now I have published the data they are visible and have a DOI


&lt;iframe src=<span style="color: #cc9393;">"http://wl.figshare.com/articles/820158/embed?show_title=1"</span> width=<span style="color: #cc9393;">"568"</span> height=<span style="color: #cc9393;">"157"</span> frameborder=<span style="color: #cc9393;">"0"</span>&gt;&lt;/iframe&gt;


</pre>


</div>

</div>

<div id="outline-container-7-3" class="outline-3">
<h3 id="sec-7-3"><span class="section-number-3">7.3</span> dc-uploader-and-ANU-DataCommons</h3>
<div class="outline-text-3" id="text-7-3">



</div>

</div>

<div id="outline-container-7-4" class="outline-3">
<h3 id="sec-7-4"><span class="section-number-3">7.4</span> morpho-and-rfigshare</h3>
<div class="outline-text-3" id="text-7-4">





</div>

</div>

<div id="outline-container-7-5" class="outline-3">
<h3 id="sec-7-5"><span class="section-number-3">7.5</span> R-spss-variable-labels-read</h3>
<div class="outline-text-3" id="text-7-5">




<pre class="src src-R"><span style="color: #7f9f7f;">################################################################</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">name:R-spss-variable-labels</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">func</span>
<span style="color: #bfebbf; font-weight: bold;">require</span>(xtable)

<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">load</span>
analyte  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> read.spss(filename, to.data.frame=T)

<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">clean</span>
names(analyte)
varslist <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> as.data.frame(attributes(analyte)$variable.labels)
write.csv(varslist, <span style="color: #cc9393;">"variable_labels.csv"</span>, row.names = T)
x <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> read.csv(<span style="color: #cc9393;">'variable_labels.csv'</span>)
head(x)
names(x)  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> c(<span style="color: #cc9393;">"variable"</span>, <span style="color: #cc9393;">"label"</span>)

<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">do</span>
x.big <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> xtable(x,label=<span style="color: #cc9393;">'tab:table1'</span>,caption=<span style="color: #cc9393;">'Variable Names and Descriptions'</span>)
align(x.big) <span style="color: #bfebbf; font-weight: bold;">&lt;-</span>  c( <span style="color: #cc9393;">'l'</span>, <span style="color: #cc9393;">'p{1in}'</span>, <span style="color: #cc9393;">'p{4in}'</span>)
  
sink(<span style="color: #cc9393;">'tab1.tex'</span>)

print(x.big,tabular.environment=<span style="color: #cc9393;">'longtable'</span>,
        floating=<span style="color: #7cb8bb;">FALSE</span>, caption.placement = <span style="color: #cc9393;">"top"</span>,
        hline.after = c(-1,nrow(x.big)), 
        add.to.row = list(pos = list(0),command = <span style="color: #cc9393;">"\\hline \\endhead "</span>),
        include.rownames=F)

sink()


</pre>



</div>
</div>

</div>

<div id="outline-container-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Exploratory Data Analysis</h2>
<div class="outline-text-2" id="text-8">

</div>

</div>

<div id="outline-container-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> General Purpose</h2>
<div class="outline-text-2" id="text-9">

</div>

</div>

<div id="outline-container-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> Visualisation</h2>
<div class="outline-text-2" id="text-10">

</div>

</div>

<div id="outline-container-11" class="outline-2">
<h2 id="sec-11"><span class="section-number-2">11</span> Statistical Modelling</h2>
<div class="outline-text-2" id="text-11">




</div>

<div id="outline-container-11-1" class="outline-3">
<h3 id="sec-11-1"><span class="section-number-3">11.1</span> Tree-Based Methods</h3>
<div class="outline-text-3" id="text-11-1">



</div>

</div>

<div id="outline-container-11-2" class="outline-3">
<h3 id="sec-11-2"><span class="section-number-3">11.2</span> Misclassification Error Rate for Classification Trees</h3>
<div class="outline-text-3" id="text-11-2">


</div>

</div>

<div id="outline-container-11-3" class="outline-3">
<h3 id="sec-11-3"><span class="section-number-3">11.3</span> Deviance Based Measures of Descriptive Power for Classification Trees</h3>
<div class="outline-text-3" id="text-11-3">

<ul>
<li id="sec-11-3-1">Computing-and-using-deviance-with-classification-trees-Ritschard, G. (2006).<br/>
I'm reading Ritschard, G. (2006). Computing and using the deviance with classification trees. In Compstat 2006 - Proceedings in Computational Statistics 17th Symposium Held in Rome, Italy, 2006. Retrieved from <a href="http://link.springer.com/chapter/10.1007/978-3-7908-1709-6_5">http://link.springer.com/chapter/10.1007%2F978-3-7908-1709-6_5</a>

<p>
This is implemented in SPSS code. I'll try to develop R code to do these tests.
</p>
<p>
First I'll get the data out of their paper and fit the tree in figure 1
</p>


</li>
</ul>
<ul>
<li id="sec-11-3-2">Reproduce the figure from the paper<br/>
The figure in the paper can be checked against our results (and also the improved plot from the party package might be used).

<p>
<img src="images/fit1.png"  alt="images/fit1.png" />
</p></li>
</ul>
<ul>
<li id="sec-11-3-3">One row per case or using weights?<br/>
Using the case weights like above is convenient especially when datasets are very large, but caused problems in model fitting for me (tree failed to compute a deviance when done this way but succeeded with a dataset expanded so the data.frame is transformed into one in which each row is an observation.



<pre class="src src-R"><span style="color: #7f9f7f;">################################################################</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">name:reassurance-re-weights</span>

<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">just to reasure myself I understand what case weights do, I'll make</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">this into a survey dataset with one row per respondent</span>
df <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> as.data.frame(matrix(<span style="color: #7cb8bb;">NA</span>, nrow = 0, ncol = 3))
<span style="color: #f0dfaf; font-weight: bold;">for</span>(i <span style="color: #f0dfaf; font-weight: bold;">in</span> 1:nrow(civst_gend_sector))
    {
    <span style="color: #7f9f7f;">#    </span><span style="color: #7f9f7f;">i &lt;- 1</span>
        n <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> civst_gend_sector$number_of_cases[i]
        <span style="color: #f0dfaf; font-weight: bold;">if</span>(n == 0) <span style="color: #f0dfaf; font-weight: bold;">next</span>
        <span style="color: #f0dfaf; font-weight: bold;">for</span>(j <span style="color: #f0dfaf; font-weight: bold;">in</span> 1:n)
            {
              df <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> rbind(df, civst_gend_sector[i,1:3])              
            }

    }
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">save this for use later</span>
write.csv(df, <span style="color: #cc9393;">"inst/extdata/civst_gend_sector_full.csv"</span>, row.names = F)
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">clean</span>
nrow(df)
str(df)
fit1 <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> rpart(civil_status ~ gender + activity_sector, data = df)
summary(fit1)

<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">report</span>
par(mfrow=c(1,2), xpd = <span style="color: #7cb8bb;">NA</span>) 
plot(fit)
text(fit, use.n = <span style="color: #7cb8bb;">TRUE</span>)
title(<span style="color: #cc9393;">"fit"</span>)
plot(fit1)
text(fit1, use.n = <span style="color: #7cb8bb;">TRUE</span>)
title(<span style="color: #cc9393;">"fit1"</span>)
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">great these are the same which is what we'd hoped to see</span>

</pre>







</li>
</ul>
<ul>
<li id="sec-11-3-4"><span class="todo TODO">TODO</span> Check This: R function to calculate for classification trees<br/>
The Ritschard (2006) paper (with SPSS code) describes a complicated method that includes Needing to retrieve for each case: 
<ul>
<li>leaf number and
</li>
<li>profile number
</li>
</ul>


<p>
I really want to use the deviance as well as the misclassification error rate for measuring the descriptive power of the tree.
Ripley's tree package is the only one I found to give me deviance for classification trees.
</p>
<p>
The Ritschard papers suggest nice methods to test differences between nested trees ie testing the difference with the root node with a Chi-square statistic (equivalent of the usual method used in logistic regression).
</p>
<p>
Is this method employed widely in analysing survey data?
I haven't turned up many references to Ritschard since he wrote these.
</p>
<p>
So let's start simple first.  The following code follows the simpler approach:
</p><ul>
<li>Take the difference in the deviance for the models (less complex model minus more complex model)
</li>
<li>Take the difference in degrees of freedom for the models
</li>
<li>difference between less complex and more complex model follows chi-square distribution
</li>
</ul>



</li>
</ul>
<ul>
<li id="sec-11-3-5">R-tree.chisq<br/>
</li>
</ul>
<ul>
<li id="sec-11-3-6">R code<br/>



<pre class="src src-R"><span style="color: #7f9f7f;">################################################################</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">name:tree.chisq</span>
<span style="color: #8cd0d3;">tree.chisq</span> <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> <span style="color: #f0dfaf; font-weight: bold;">function</span>(null_model, fitted_model)
{
    <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">TODO check if these are tree model class</span>
    fit_dev  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> summary(fitted_model)$dev
    null_dev  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> summary(null_model)$dev    
    dev  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span>  null_dev - fit_dev
    df  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> summary(fitted_model)$size - summary(null_model)$size
    sig  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> 1 - pchisq(dev, df)
    sprintf(<span style="color: #cc9393;">"Reduction in deviance is %s percent, p-value is %s (based on a chi-squared test)"</span>,
            ((null_dev - fit_dev) / null_dev) * 100,
            sig)
}

</pre>

</li>
</ul>
<ul>
<li id="sec-11-3-7">test-tree.chisq<br/>



<pre class="src src-R"><span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">func</span>
<span style="color: #bfebbf; font-weight: bold;">require</span>(tree)
<span style="color: #bfebbf; font-weight: bold;">require</span>(devtools)
install_github(<span style="color: #cc9393;">"TransformSurveyTools"</span>, <span style="color: #cc9393;">"ivanhanigan"</span>)
<span style="color: #bfebbf; font-weight: bold;">require</span>(TransformSurveyTools)
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">load locally</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">fpath  &lt;- "inst/extdata/civst_gend_sector_full.csv"</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">or via package</span>
fpath <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> system.file(<span style="color: #cc9393;">"extdata"</span>, <span style="color: #cc9393;">"civst_gend_sector_full.csv"</span>, package=<span style="color: #cc9393;">"TransformSurveyTools"</span>)
civst_gend_sector  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> read.csv(fpath)

<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">clean</span>
str(civst_gend_sector)

<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">do</span>
variables  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> names(civst_gend_sector)
y_variable  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> variables[1]
x_variables  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> variables[-1]

<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">NULL</span>
form0  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> reformulate(<span style="color: #cc9393;">"1"</span>,
                      response = y_variable)
form0
model0 <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> tree(form0, data = civst_gend_sector, method = <span style="color: #cc9393;">"class"</span>)
print(model0)
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">FIT</span>
form1  <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> reformulate(x_variables,
                      response = y_variable)
form1
model1 <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> tree(form1, data = civst_gend_sector, method = <span style="color: #cc9393;">"class"</span>)
print(model1)
summary(model1)
plot(model1)
text(model1,pretty = 0)
tree.chisq(null_model = model0, fitted_model = model1)

</pre>



</li>
</ul>
<ul>
<li id="sec-11-3-8">main-tree-model<br/>



<pre class="src src-R"><span style="color: #bfebbf; font-weight: bold;">source</span>(<span style="color: #cc9393;">"tests/test-tree.chisq.r"</span>)
</pre>


</li>
</ul>
</div>
</div>

</div>

<div id="outline-container-12" class="outline-2">
<h2 id="sec-12"><span class="section-number-2">12</span> Code Editors</h2>
<div class="outline-text-2" id="text-12">

</div>

</div>

<div id="outline-container-13" class="outline-2">
<h2 id="sec-13"><span class="section-number-2">13</span> Workflow Tools</h2>
<div class="outline-text-2" id="text-13">


</div>

<div id="outline-container-13-1" class="outline-3">
<h3 id="sec-13-1"><span class="section-number-3">13.1</span> R-newnode</h3>
<div class="outline-text-3" id="text-13-1">



</div>

<div id="outline-container-13-1-1" class="outline-4">
<h4 id="sec-13-1-1"><span class="section-number-4">13.1.1</span> test-newnode</h4>
<div class="outline-text-4" id="text-13-1-1">




<pre class="src src-R"><span style="color: #7f9f7f;">################################################################</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">name:newnode</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">REQUIRES GRAPHVIZ, AND TO INSTALL RGRAPHVIZ</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">source('http://bioconductor.org/biocLite.R')</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">biocLite("Rgraphviz")</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">or may be needed for eg under ubuntu</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">biocLite("Rgraphviz", configure.args=c("--with-graphviz=/usr"))</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">FURTHER INFO</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">see the Rgraphviz examples</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">example(layoutGraph)</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">require(biocGraph) # for imageMap</span>

<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">source("R/newnode.r")</span>
<span style="color: #bfebbf; font-weight: bold;">require</span>(devtools)
install_github(<span style="color: #cc9393;">"disentangle"</span>, <span style="color: #cc9393;">"ivanhanigan"</span>)
<span style="color: #bfebbf; font-weight: bold;">require</span>(disentangle)
newnode(
  name = <span style="color: #cc9393;">"NAME"</span>
  ,
  inputs=<span style="color: #cc9393;">"INPUT"</span>
  ,
  outputs = <span style="color: #cc9393;">"OUTPUT"</span>
  ,
  graph = <span style="color: #cc9393;">'nodes'</span>
  ,
  newgraph=T
  ,
  notes=F
  ,
  code=<span style="color: #7cb8bb;">NA</span>
  ,
  ttype=<span style="color: #7cb8bb;">NA</span>
  ,
  plot = T
  )

nodes <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> newnode(<span style="color: #cc9393;">"merge"</span>, c(<span style="color: #cc9393;">"d1"</span>, <span style="color: #cc9393;">"d2"</span>, <span style="color: #cc9393;">"d3"</span>), c(<span style="color: #cc9393;">"EDA"</span>),
                 newgraph =T)
nodes <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> newnode(<span style="color: #cc9393;">"qc"</span>, c(<span style="color: #cc9393;">"data1"</span>, <span style="color: #cc9393;">"data2"</span>, <span style="color: #cc9393;">"data3"</span>), c(<span style="color: #cc9393;">"d1"</span>, <span style="color: #cc9393;">"d2"</span>, <span style="color: #cc9393;">"d3"</span>))
nodes <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> newnode(<span style="color: #cc9393;">"modelling"</span>, <span style="color: #cc9393;">"EDA"</span>)
nodes <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> newnode(<span style="color: #cc9393;">"model checking"</span>, <span style="color: #cc9393;">"modelling"</span>, c(<span style="color: #cc9393;">"data checking"</span>, <span style="color: #cc9393;">"reporting"</span>))
<span style="color: #7f9f7f;">#</span><span style="color: #7f9f7f;">require(disentangle)</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">either edit a spreadsheet with filenames, inputs and outputs </span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">filesList &lt;- read.csv("exampleFilesList.csv", stringsAsFactors = F)</span>
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">or </span>
filesList <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> read.csv(textConnection(
<span style="color: #cc9393;">'FILE,INPUTS,OUTPUTS,DESCRIPTION</span>
<span style="color: #cc9393;">siteIDs,GPS,,latitude and longitude of sites</span>
<span style="color: #cc9393;">weather,BoM,,weather data from BoM</span>
<span style="color: #cc9393;">trapped,siteIDs,,counts of species caught in trap</span>
<span style="color: #cc9393;">biomass,siteIDs,,</span>
<span style="color: #cc9393;">corralations,"weather,trapped,biomass",report1,A study we published</span>
<span style="color: #cc9393;">paper1,report1,"open access repository, data package",</span>
<span style="color: #cc9393;">'</span>), stringsAsFactors = F)
<span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">start the graph</span>
i <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> 1
nodes <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> newnode(name = filesList[i,1],
                 inputs = strsplit(filesList$INPUTS, <span style="color: #cc9393;">","</span>)[[i]],
                 outputs =
                 strsplit(filesList$OUTPUTS, <span style="color: #cc9393;">","</span>)[[i]]
                 ,
                 newgraph=T)
 
<span style="color: #f0dfaf; font-weight: bold;">for</span>(i <span style="color: #f0dfaf; font-weight: bold;">in</span> 2:nrow(filesList))
{
  <span style="color: #7f9f7f;"># </span><span style="color: #7f9f7f;">i &lt;- 2</span>
  <span style="color: #f0dfaf; font-weight: bold;">if</span>(length(strsplit(filesList$OUTPUTS, <span style="color: #cc9393;">","</span>)[[i]]) == 0)
  {
    nodes <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> newnode(name = filesList[i,1],
                     inputs = strsplit(filesList$INPUTS, <span style="color: #cc9393;">","</span>)[[i]]
    )    
  } <span style="color: #f0dfaf; font-weight: bold;">else</span> {
    nodes <span style="color: #bfebbf; font-weight: bold;">&lt;-</span> newnode(name = filesList[i,1],
                     inputs = strsplit(filesList$INPUTS, <span style="color: #cc9393;">","</span>)[[i]],
                     outputs = strsplit(filesList$OUTPUTS, <span style="color: #cc9393;">","</span>)[[i]]
    )
  }
}
 
<span style="color: #7f9f7f;">#</span><span style="color: #7f9f7f;">dev.copy2pdf(file='fileTransformations.pdf')</span>
<span style="color: #7f9f7f;">#</span><span style="color: #7f9f7f;">dev.off();</span>
 
</pre>



</div>
</div>
</div>

</div>

<div id="outline-container-14" class="outline-2">
<h2 id="sec-14"><span class="section-number-2">14</span> Graphical User Interfaces</h2>
<div class="outline-text-2" id="text-14">

</div>

</div>

<div id="outline-container-15" class="outline-2">
<h2 id="sec-15"><span class="section-number-2">15</span> Version Control</h2>
<div class="outline-text-2" id="text-15">

</div>

</div>

<div id="outline-container-16" class="outline-2">
<h2 id="sec-16"><span class="section-number-2">16</span> Latex/Sweave</h2>
<div class="outline-text-2" id="text-16">

</div>

</div>

<div id="outline-container-17" class="outline-2">
<h2 id="sec-17"><span class="section-number-2">17</span> R Packages</h2>
<div class="outline-text-2" id="text-17">

</div>

</div>

<div id="outline-container-18" class="outline-2">
<h2 id="sec-18"><span class="section-number-2">18</span> Project Management</h2>
<div class="outline-text-2" id="text-18">

</div>

</div>

<div id="outline-container-19" class="outline-2">
<h2 id="sec-19"><span class="section-number-2">19</span> Operating Systems</h2>
<div class="outline-text-2" id="text-19">

</div>

</div>

<div id="outline-container-20" class="outline-2">
<h2 id="sec-20"><span class="section-number-2">20</span> Big Data Tips</h2>
<div class="outline-text-2" id="text-20">

</div>

</div>

<div id="outline-container-21" class="outline-2">
<h2 id="sec-21"><span class="section-number-2">21</span> Writing</h2>
<div class="outline-text-2" id="text-21">

</div>
</div>
</div>

</body>
</html>
